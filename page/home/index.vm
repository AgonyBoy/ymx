#extends("/page/layout/default.vm")
  #block("head_other")
    #require("/components/progressbar/progressbar.js")
    #require("/components/masonry/masonry.pkgd.js")
  <style>
    div.ymx-list{
      width:100%;
      float:left;
      padding:2px;
    }
    li.star-item{
      width:50%;
      padding:3px;
      float:left;
    }
    div.star-info{
      width:100%;
      float:left;
      padding:5px;
      background-color:#FFF;
    }
    div.star-info > span.send-user{
      width:100%;
      padding-left:30px;
      float:left;
      text-indent:5px;
      line-height:30px;
      display:block;
    }
    div.star-info > span.send-user > i{
      width:30px;
      height:30px;
      display:block;
      float:left;
      margin-left:-30px;
      border-radius:50%;
      overflow:hidden;
    }
    div.star-info > span.thumb-img{width:100%;height:auto;display:block;padding:5px 0;float:left;}
    div.star-info > span.thumb-img > img{width:100%;height:auto;float:left;}
    div.star-info > span.send-user > i > img{
      width:100%;
      height:auto;
      float:left;
      border:0;
    }
    div.item-info{
      position:relative;
      width:100%;
      float:left;
    }
    div.item-info > label{
      position:absolute !important;
      width:40px;
      height:40px;
      display:block;
      bottom:0;
      right:5px;
    }
    p.item-tit{
      color:#000;
      text-align:left;
      white-space:nowrap;
      overflow:hidden;
      font-size:15px;
      margin-bottom:10px;
      text-overflow:ellipsis;
    }
    p.item-row:before{padding-right:5px;}
    p.item-row{
      font-size:13px;
    }
    ul#layout{float:left;}
  </style>
  #end
  #block("header")#end
  #block("content")
    <div class="mui-content">
      <!-- 引用轮播图小组件：参数banners  -->
      
      #widget("/widget/slider-banner.vm" "var:banners=$!pictures")
      <!-- 约星列表 -->
      <div class="ymx-list">
        <ul id="container"></ul>
      </div>
    </div>
  #end

  <!--底部菜单-->
  #block("footer")#widget("/widget/footer.vm")#end
  ## #block("footer")#widget("/widget/footerV2.vm")#end

  <!--当前页面js-->
  #block("back_script")
  <script type="text/template" id="indexTmpl">
    <%_.each(list,function(item){%>
      <li class="star-item">
        <div class="star-info">
          <span class="send-user">
            <i><img src="<%=item.userPhoto%>"/></i>
            <p><%=item.userName%></p>
          </span>
          <span class="thumb-img"><img src="<%=item.thumbImg%>"/></span>
          <div class="item-info">
            <p class="item-tit"><%=item.activityTile%></p>
            <p class="item-row ymx guanz"><%=item.userCount%>人跟约</p>
            <p class="item-row ymx time"><%=item.sendTime%></p>
            <label id="ratio<%=item.itemId%>" progress="<%=item.ratio%>"></label>
          </div>
        </div>
      </li>
    <%});%>
  </script>
  <script type="text/javascript">
    var _tmpl = _.template($("#indexTmpl").html());
    var _grid = $("#container").masonry({itemSelector:".star-item"});
    $(function(){
            /*设置轮播图自动滚动间隔*/
            var slider = mui("#slider");
                slider.slider({interval: 5000});

            /**
             * 添加滚动条事件加载数据
             */
            scrollEvent({
              addStatus:"正在加载...",
              stopStatus:"上拉加载更多",
              overStatus:"已加载全部",
              autoLoad:true,
              callback:function(more){
                addData(more,1,10);
              }
            });

            /**
             * 加载新数据
             */
            function addData(more,page,count){
              mui.ajax('/home/get/item',{
                data:{
                  page:page,
                  count:count
                },
                dataType:'json',
                type:'post',               
                success:function(data){
                    var _html =$(_tmpl({list:data.data}));               //获取模板数据
                    $("#container").append(_html);                    //添加新数据
                    if(_grid!=undefined){
                      _grid.masonry('destroy');                       //摧毁瀑布流布局
                    }
                    _grid=_grid.masonry({itemSelector:".star-item"}); //重新布局瀑布流
                    more.loadPoint();                                 //滚动到上次加载位置
                    more.refreshMore(false);                          //改变底部加载状态
                    _html.each(function(index,item){
                      if($(item).attr("class")=="star-item"){
                        var _dom =$(item).find("label");
                        var _id ="#"+_dom.attr("id");
                        var _ratio = _dom.attr("progress");
                        // _dom.createProgress(_ratio);
                        addProgress(_id,_ratio);
                      }
                    });
                },
                error:function(xhr,type,errorThrown){
                  console.log(type);
                }
              });
            }
    });

    function addProgress(id,ratio){
      //var _color ="#"+("00000"+((Math.random()*16777215+0.5)>>0).toString(16)).slice(-6); //随机颜色
          var bar = new ProgressBar.Circle(id, { //创建进度条对象
            strokeWidth: 5,
            easing: 'easeInOut',
            duration: 1400,
            color: "#da251d",
            trailColor: '#dfdfdf',
            trailWidth: 2,
            svgStyle: null,
            step: function(state, circle) {
                  var value = Math.round(circle.value() * 100);
                  if (value === 0) {
                    circle.setText('');
                  } else {
                    circle.setText(value+"%");
                  }
                }
          });
          bar.text.style.fontSize = '0.5rem';
          bar.animate(ratio);  // 加载进度条动画
    }
  </script>
  #end
#end